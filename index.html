<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow | Cloud Sync</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.3); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .glass-item:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-1px);
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-avatar { transition: transform 0.2s; }
        .user-avatar:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCuQLeXXVYEgG9TJ1XR_FvlD1ABqsgEXX4",
            authDomain: "focus-flow-512ee.firebaseapp.com",
            projectId: "focus-flow-512ee",
            storageBucket: "focus-flow-512ee.firebasestorage.app",
            messagingSenderId: "861618381374",
            appId: "1:861618381374:web:4692b742e3661e539c676f",
            measurementId: "G-33P6VZPJ7Y"
        };

        // 2. SAFE INITIALIZATION
        let auth = null;
        let db = null;
        let isFirebaseEnabled = false;

        try {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseEnabled = true;
                console.log("Firebase connected.");
            } else {
                console.warn("Firebase SDK not loaded or config missing. Running in offline mode.");
            }
        } catch (e) {
            console.error("Firebase Init Failed:", e);
        }

        // 3. ICONS
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                check: <path d="M20 6L9 17l-5-5" />,
                trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                plus: <path d="M12 5v14M5 12h14" />,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></g>,
                save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></g>,
                image: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                grip: <g><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></g>,
                google: <path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.2-4.5v-3.3h5.5c.1.5.1 1.1.1 1.7 0 3.3-2.2 5.7-5.6 5.7-3.2 0-5.9-2.6-5.9-5.9s2.6-5.9 5.9-5.9c1.6 0 3 1.2 3.6 1.8l-2.4 2.3c-.4-.4-1-.9-1.2-.9-1.5 0-2.7 1.2-2.7 2.7s1.2 2.7 2.7 2.7c1.7 0 2.4-1.2 2.5-1.9h-2.5z" fill="currentColor" />,
                logout: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></g>
            };

            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        // 4. APP COMPONENT
        const App = () => {
            const [user, setUser] = useState(null);
            const [todos, setTodos] = useState([]);
            const [inputValue, setInputValue] = useState("");
            const [filter, setFilter] = useState("all"); 
            const [editingId, setEditingId] = useState(null);
            const [editValue, setEditValue] = useState("");
            const [bgImage, setBgImage] = useState("https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=2574&auto=format&fit=crop"); 
            const [showBgInput, setShowBgInput] = useState(false);
            const [bgInputValue, setBgInputValue] = useState("");
            const [isLoading, setIsLoading] = useState(true);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);

            // Auth Listener
            useEffect(() => {
                if (isFirebaseEnabled && auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        if(!u) setIsLoading(false);
                    });
                    return () => unsubscribe();
                } else {
                    setIsLoading(false);
                }
            }, []);

            // Data Sync
            useEffect(() => {
                if (isFirebaseEnabled && user && db) {
                    setIsLoading(true);
                    const unsubscribe = db.collection('users')
                        .doc(user.uid)
                        .collection('todos')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot((snapshot) => {
                            const newTodos = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setTodos(newTodos);
                            setIsLoading(false);
                        }, (error) => {
                            console.error("Sync Error:", error);
                            setIsLoading(false);
                        });
                    
                    db.collection('users').doc(user.uid).get().then(doc => {
                        if (doc.exists && doc.data().bgImage) {
                            setBgImage(doc.data().bgImage);
                        }
                    }).catch(e => console.log("BG Fetch Error", e));

                    return () => unsubscribe();
                } 
                else if (!user) {
                    try {
                        const savedTodos = localStorage.getItem('focusflow_todos');
                        const savedBg = localStorage.getItem('focusflow_bg');
                        if (savedTodos) {
                            const parsed = JSON.parse(savedTodos);
                            setTodos(Array.isArray(parsed) ? parsed : []);
                        }
                        if (savedBg) setBgImage(savedBg);
                    } catch (e) {
                        console.error("Local Storage Error", e);
                        setTodos([]); 
                    }
                    setIsLoading(false);
                }
            }, [user]);

            // Save to LocalStorage (Guest Only)
            useEffect(() => {
                if (!user) {
                    localStorage.setItem('focusflow_todos', JSON.stringify(todos));
                }
            }, [todos, user]);

            useEffect(() => {
                if (!user) {
                    localStorage.setItem('focusflow_bg', bgImage);
                }
            }, [bgImage, user]);

            // Actions
            const login = async () => {
                if (!isFirebaseEnabled || !auth) {
                    alert("Firebase not connected. Check internet or config.");
                    return;
                }
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    alert("Login failed: " + error.message);
                }
            };

            const logout = () => {
                if(auth) auth.signOut();
                setTodos([]);
            };

            const addTodo = async (e) => {
                e.preventDefault();
                if (!inputValue.trim()) return;
                
                const newTodo = {
                    text: inputValue.trim(),
                    completed: false,
                    createdAt: Date.now()
                };

                // --- FIX 1: Clear input immediately (Optimistic UI) ---
                setInputValue(""); 

                if (user && isFirebaseEnabled && db) {
                    await db.collection('users').doc(user.uid).collection('todos').add(newTodo);
                } else {
                    setTodos([{ id: Date.now(), ...newTodo }, ...todos]);
                }
            };

            const toggleComplete = async (todo) => {
                if (user && isFirebaseEnabled && db) {
                    await db.collection('users').doc(user.uid).collection('todos').doc(todo.id).update({
                        completed: !todo.completed
                    });
                } else {
                    setTodos(todos.map(t => t.id === todo.id ? { ...t, completed: !todo.completed } : t));
                }
            };

            const deleteTodo = async (id) => {
                if (user && isFirebaseEnabled && db) {
                    await db.collection('users').doc(user.uid).collection('todos').doc(id).delete();
                } else {
                    setTodos(todos.filter(t => t.id !== id));
                }
            };

            const saveEdit = async () => {
                if (!editValue.trim()) { setEditingId(null); return; }
                
                // --- FIX 2: Close Edit Mode Immediately (Optimistic UI) ---
                const tempId = editingId;
                const tempVal = editValue.trim();
                setEditingId(null); 

                if (user && isFirebaseEnabled && db) {
                    await db.collection('users').doc(user.uid).collection('todos').doc(tempId).update({
                        text: tempVal
                    });
                } else {
                    setTodos(todos.map(t => t.id === tempId ? { ...t, text: tempVal } : t));
                }
            };

            const handleBgUpdate = async (url) => {
                setBgImage(url);
                if (user && isFirebaseEnabled && db) {
                    await db.collection('users').doc(user.uid).set({ bgImage: url }, { merge: true });
                }
            };
            
            const handleDragStart = (index) => setDraggedItemIndex(index);
            const handleDragEnter = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;
                const newTodos = [...todos];
                const item = newTodos[draggedItemIndex];
                newTodos.splice(draggedItemIndex, 1);
                newTodos.splice(index, 0, item);
                setDraggedItemIndex(index);
                setTodos(newTodos);
            };
            const handleDragEnd = () => setDraggedItemIndex(null);

            const filteredTodos = (todos || []).filter(todo => {
                if (filter === "active") return !todo.completed;
                if (filter === "completed") return todo.completed;
                return true;
            });

            const stats = {
                total: (todos || []).length,
                active: (todos || []).filter(t => !t.completed).length,
                completed: (todos || []).filter(t => t.completed).length
            };

            return (
                <div 
                    className="min-h-screen w-full flex items-center justify-center p-4 sm:p-8 relative transition-all duration-700 ease-in-out bg-cover bg-center bg-no-repeat"
                    style={{ 
                        backgroundImage: `url('${bgImage}')`,
                        backgroundColor: '#f3f4f6' 
                    }}
                >
                    <div className="absolute inset-0 bg-black/20 pointer-events-none"></div>

                    <div className="w-full max-w-2xl glass-panel rounded-3xl overflow-hidden flex flex-col shadow-2xl animate-fade-in z-10" style={{height: '85vh', maxHeight: '900px'}}>
                        
                        {/* Header */}
                        <div className="p-6 sm:p-8 border-b border-white/40 relative">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3 drop-shadow-sm">
                                        <span className="bg-indigo-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-500/30">
                                            <Icon name="check" size={22} />
                                        </span>
                                        FocusFlow
                                    </h1>
                                    <p className="text-gray-600 font-medium text-sm mt-2 ml-1 flex items-center gap-2">
                                        {user ? (
                                            <span className="text-green-700 bg-green-100 px-2 py-0.5 rounded-md text-xs flex items-center gap-1">
                                                Cloud Sync Active
                                            </span>
                                        ) : (
                                            <span className="text-amber-700 bg-amber-100 px-2 py-0.5 rounded-md text-xs flex items-center gap-1">
                                                Local Mode (Guest)
                                            </span>
                                        )}
                                    </p>
                                </div>
                                
                                <div className="flex gap-2 items-center">
                                    <button onClick={() => setShowBgInput(!showBgInput)} className="bg-white/50 hover:bg-white/80 p-2.5 rounded-full transition-all text-gray-700 backdrop-blur-sm shadow-sm">
                                        <Icon name="image" size={18} />
                                    </button>

                                    {user ? (
                                        <div className="flex items-center gap-3 bg-white/50 pl-3 pr-1.5 py-1.5 rounded-full backdrop-blur-sm shadow-sm">
                                            <span className="text-xs font-bold text-gray-700 truncate max-w-[100px]">
                                                {user.displayName}
                                            </span>
                                            <img src={user.photoURL} className="w-8 h-8 rounded-full border-2 border-white shadow-sm user-avatar" alt="User" />
                                            <button onClick={logout} className="bg-white hover:bg-red-50 text-gray-500 hover:text-red-600 p-1.5 rounded-full transition-colors" title="Sign Out">
                                                <Icon name="logout" size={16} />
                                            </button>
                                        </div>
                                    ) : (
                                        <button onClick={login} className="flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-full font-semibold text-sm shadow-md transition-all transform hover:scale-105">
                                            <div className="text-indigo-600"><Icon name="google" size={16} /></div>
                                            Sign In
                                        </button>
                                    )}
                                </div>
                            </div>

                            {showBgInput && (
                                <form onSubmit={(e) => { e.preventDefault(); handleBgUpdate(bgInputValue); setShowBgInput(false); }} className="mb-4 animate-fade-in bg-white/80 p-3 rounded-xl shadow-lg flex gap-2 items-center border border-white/60">
                                    <input type="text" placeholder="Paste image URL here..." className="flex-1 bg-transparent border-none text-sm text-gray-800 placeholder-gray-500 focus:ring-0 p-1" value={bgInputValue} onChange={(e) => setBgInputValue(e.target.value)} autoFocus />
                                    <button type="submit" className="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-indigo-700 transition">Set</button>
                                    <button type="button" onClick={() => setShowBgInput(false)} className="text-gray-500 hover:text-gray-800 p-1"><Icon name="x" size={16} /></button>
                                </form>
                            )}

                            <div className="w-full bg-white/40 rounded-full h-1.5 mb-6 overflow-hidden">
                                <div className="bg-indigo-600 h-full rounded-full transition-all duration-700 shadow-[0_0_10px_rgba(79,70,229,0.5)]" style={{ width: `${stats.total === 0 ? 0 : (stats.completed / stats.total) * 100}%` }}></div>
                            </div>

                            <form onSubmit={addTodo} className="relative group">
                                <input type="text" placeholder={user ? "Add a task to cloud..." : "Add a local task..."} className="w-full pl-5 pr-14 py-4 glass-input rounded-2xl text-gray-800 placeholder-gray-500 outline-none transition-all shadow-inner text-lg" value={inputValue} onChange={(e) => setInputValue(e.target.value)} />
                                <button type="submit" disabled={!inputValue.trim()} className="absolute right-2 top-2 bottom-2 aspect-square bg-indigo-600 hover:bg-indigo-700 disabled:opacity-0 text-white rounded-xl flex items-center justify-center transition-all shadow-lg shadow-indigo-500/30 transform hover:scale-105 active:scale-95">
                                    <Icon name="plus" size={22} />
                                </button>
                            </form>
                        </div>

                        <div className="flex border-b border-white/30 px-8 bg-white/20 backdrop-blur-md">
                            {['all', 'active', 'completed'].map((f) => (
                                <button key={f} onClick={() => setFilter(f)} className={`py-4 px-4 font-medium text-sm border-b-2 transition-all capitalize tracking-wide ${filter === f ? 'border-indigo-600 text-indigo-800' : 'border-transparent text-gray-600 hover:text-gray-900 hover:bg-white/20'}`}>
                                    {f} <span className={`ml-1 text-[10px] px-1.5 py-0.5 rounded-full ${filter === f ? 'bg-indigo-100 text-indigo-700' : 'bg-white/40 text-gray-600'}`}>{f === 'all' ? stats.total : f === 'active' ? stats.active : stats.completed}</span>
                                </button>
                            ))}
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 space-y-3 custom-scrollbar relative">
                            {isLoading ? (
                                <div className="absolute inset-0 flex items-center justify-center bg-white/20 backdrop-blur-sm z-20">
                                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                </div>
                            ) : filteredTodos.length === 0 ? (
                                <div className="text-center py-16 opacity-60">
                                    <div className="bg-white/30 p-4 rounded-full mb-4 backdrop-blur-sm inline-block">
                                        <Icon name="check" size={32} className="text-gray-600" />
                                    </div>
                                    <p className="text-gray-700 font-medium">No tasks found</p>
                                </div>
                            ) : (
                                filteredTodos.map((todo, index) => (
                                    <div 
                                        key={todo.id}
                                        // --- FIX 3: Enable Drag & Drop (Removed !user check) ---
                                        draggable={filter === 'all'} 
                                        onDragStart={() => handleDragStart(index)}
                                        onDragEnter={(e) => handleDragEnter(e, index)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={(e) => e.preventDefault()}
                                        className={`group glass-item p-4 rounded-2xl shadow-sm transition-all flex items-center gap-4 ${draggedItemIndex === index ? 'opacity-40 border-dashed border-indigo-400' : ''}`}
                                    >
                                        <button onClick={() => toggleComplete(todo)} className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300 ${todo.completed ? 'bg-green-500 border-green-500 text-white shadow-[0_0_10px_rgba(34,197,94,0.4)]' : 'border-gray-400 text-transparent hover:border-indigo-500 bg-white/40'}`}>
                                            <Icon name="check" size={14} />
                                        </button>

                                        <div className="flex-1 min-w-0">
                                            {editingId === todo.id ? (
                                                <div className="flex items-center gap-2 animate-fade-in">
                                                    <input type="text" value={editValue} onChange={(e) => setEditValue(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') saveEdit(); if(e.key === 'Escape') setEditingId(null); }} autoFocus className="w-full px-3 py-1.5 bg-white/80 border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800" />
                                                    <button onClick={saveEdit} className="text-green-600 bg-white/80 hover:bg-green-50 p-1.5 rounded-lg shadow-sm"><Icon name="save" size={18} /></button>
                                                </div>
                                            ) : (
                                                <div onDoubleClick={() => { setEditingId(todo.id); setEditValue(todo.text); }} className="cursor-pointer">
                                                    <span className={`block truncate transition-all text-[17px] ${todo.completed ? 'line-through text-gray-500/70' : 'text-gray-800 font-medium'}`}>
                                                        {todo.text}
                                                    </span>
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-all scale-95 group-hover:scale-100">
                                            {/* Add Drag Grip Icon */}
                                            {filter === 'all' && (
                                                <div className="cursor-grab text-gray-400 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity mr-1">
                                                    <Icon name="grip" size={14} />
                                                </div>
                                            )}
                                            <button onClick={() => { setEditingId(todo.id); setEditValue(todo.text); }} className="p-2 text-gray-500 hover:text-indigo-600 hover:bg-white/60 rounded-lg transition-colors"><Icon name="edit" size={18} /></button>
                                            <button onClick={() => deleteTodo(todo.id)} className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50/50 rounded-lg transition-colors"><Icon name="trash" size={18} /></button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        <div className="bg-white/30 backdrop-blur-md p-4 border-t border-white/40 flex justify-between items-center text-sm text-gray-700 font-medium">
                            <span>{stats.active} active task{stats.active !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>