<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow | Production Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; background: #111; color: #fff; }
        
        /* Ultra Glass Theme - Refined */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); 
        }
        
        .glass-sidebar {
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Draggable Cards */
        .block-card { 
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.2s;
            border-left: 4px solid transparent;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #1f2937;
        }
        .block-card:hover { 
            transform: translateY(-2px); 
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .block-card.dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .block-type-service { border-left-color: #4f46e5; } 
        .block-type-material { border-left-color: #ea580c; } 
        .block-type-milestone { border-left-color: #16a34a; } 

        /* Scrollbar - Made more visible */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.4); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.6); }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Inputs */
        input, select, textarea { background: transparent !important; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; }
        input::placeholder { color: rgba(0,0,0,0.4); }

        /* Print Styles for Agreement */
        @media print {
            body * { visibility: hidden; }
            #agreement-print-area, #agreement-print-area * { visibility: visible; }
            #agreement-print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuQLeXXVYEgG9TJ1XR_FvlD1ABqsgEXX4",
            authDomain: "focus-flow-512ee.firebaseapp.com",
            projectId: "focus-flow-512ee",
            storageBucket: "focus-flow-512ee.firebasestorage.app",
            messagingSenderId: "861618381374",
            appId: "1:861618381374:web:4692b742e3661e539c676f",
            measurementId: "G-33P6VZPJ7Y"
        };

        let auth = null, db = null, isFirebaseEnabled = false;
        try {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseEnabled = true;
            }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        // --- ICONS ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />,
                layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
                settings: <g><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></g>,
                trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                plus: <path d="M12 5v14M5 12h14" />,
                check: <path d="M20 6L9 17l-5-5" />,
                link: <g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g>,
                fileText: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></g>,
                logOut: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></g>,
                chevronRight: <polyline points="9 18 15 12 9 6" />,
                chevronDown: <polyline points="6 9 12 15 18 9" />,
                image: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                grip: <g><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></g>,
                print: <g><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const defaultAgreement = `AGREEMENT FOR SERVICES

BETWEEN: [Company Name] ("Provider")
AND: [Client Name] ("Client")

1. SERVICES
Provider agrees to perform the services described in the attached Project Estimate.

2. PAYMENT
Total Estimated Cost: [Total Price]
Payment terms: 50% upfront, 50% upon completion.

3. TIMELINE
Services will be delivered according to the milestones defined in the project scope.

Date: [Date]
Signed: __________________________`;

        const App = () => {
            const [user, setUser] = useState(null);
            const [settings, setSettings] = useState({ 
                companyName: "Production Studio", 
                logoUrl: "", 
                bgImage: "https://images.unsplash.com/photo-1600607686527-6fb886090705?q=80&w=2727&auto=format&fit=crop",
                agreementText: defaultAgreement
            });
            const [projects, setProjects] = useState([]);
            const [predefinedServices, setPredefinedServices] = useState([]);
            const [activeProjectId, setActiveProjectId] = useState(null);
            
            // UI States
            const [showSettings, setShowSettings] = useState(false);
            const [showInvoice, setShowInvoice] = useState(false);
            const [showServiceManager, setShowServiceManager] = useState(false);
            const [showAgreement, setShowAgreement] = useState(false);
            const [servicesExpanded, setServicesExpanded] = useState(false);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            const fileInputRef = useRef(null);

            const activeProject = projects.find(p => p.id === activeProjectId) || { name: "Untitled Project", blocks: [] };

            useEffect(() => {
                if (!isFirebaseEnabled) return;
                return auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) {
                        // Load Settings
                        db.collection('users').doc(u.uid).collection('settings').doc('config').onSnapshot(doc => {
                            if(doc.exists) setSettings(prev => ({...prev, ...doc.data()}));
                        });
                        // Load Projects
                        db.collection('users').doc(u.uid).collection('projects').orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                            const loadedProjects = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                            setProjects(loadedProjects);
                            if(loadedProjects.length > 0 && !activeProjectId) setActiveProjectId(loadedProjects[0].id);
                        });
                        // Load Predefined Services
                        db.collection('users').doc(u.uid).collection('services').onSnapshot(snapshot => {
                            setPredefinedServices(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                        });
                    }
                });
            }, [activeProjectId]);

            const login = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) { alert(e.message); } };
            const logout = () => auth.signOut();

            const createProject = async () => {
                const name = prompt("Enter Project Name:");
                if(name && user) {
                    const docRef = await db.collection('users').doc(user.uid).collection('projects').add({
                        name, blocks: [], createdAt: Date.now(), updatedAt: Date.now()
                    });
                    setActiveProjectId(docRef.id);
                }
            };

            const updateSettings = (newSettings) => {
                setSettings(newSettings);
                if(user) db.collection('users').doc(user.uid).collection('settings').doc('config').set(newSettings, { merge: true });
            };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (file.size > 500000) return alert("Image too large! Max 500KB.");
                const reader = new FileReader();
                reader.onloadend = () => {
                    updateSettings({ ...settings, logoUrl: reader.result });
                };
                reader.readAsDataURL(file);
            };

            // --- SERVICE BUILDER LOGIC ---
            const savePredefinedService = async (serviceData) => {
                if(user) {
                    if(serviceData.id) {
                        await db.collection('users').doc(user.uid).collection('services').doc(serviceData.id).update(serviceData);
                    } else {
                        await db.collection('users').doc(user.uid).collection('services').add(serviceData);
                    }
                }
            };

            const addBlock = (type, template = null) => {
                if(!activeProjectId) return alert("Create a project first!");
                
                let newBlock = {
                    id: Date.now().toString(),
                    type, // 'service', 'material', 'milestone', 'service-template'
                    title: type === 'service' ? 'New Service' : type === 'material' ? 'New Material' : 'New Milestone',
                    price: 0, link: '', notes: '', completed: false
                };

                if (type === 'service-template' && template) {
                    newBlock = {
                        ...newBlock,
                        title: template.name,
                        templateId: template.id,
                        selectedLevel: 'standard', // Default
                        levels: template.levels,
                        price: template.levels.standard?.active ? template.levels.standard.price : 0,
                        notes: template.levels.standard?.active ? template.levels.standard.desc : ''
                    };
                    // Auto-select first active level if standard isn't
                    if (!template.levels.standard?.active) {
                        if (template.levels.basic?.active) {
                            newBlock.selectedLevel = 'basic';
                            newBlock.price = template.levels.basic.price;
                            newBlock.notes = template.levels.basic.desc;
                        } else if (template.levels.premium?.active) {
                            newBlock.selectedLevel = 'premium';
                            newBlock.price = template.levels.premium.price;
                            newBlock.notes = template.levels.premium.desc;
                        }
                    }
                }

                const updatedBlocks = [...activeProject.blocks, newBlock];
                updateProjectBlocks(updatedBlocks);
            };

            const updateBlock = (blockId, field, value) => {
                let updatedBlocks = activeProject.blocks.map(b => {
                    if (b.id !== blockId) return b;
                    let updatedBlock = { ...b, [field]: value };
                    
                    // Handle Template Level Switching
                    if (field === 'selectedLevel' && b.type === 'service-template') {
                        const levelData = b.levels[value];
                        if (levelData) {
                            updatedBlock.price = levelData.price;
                            updatedBlock.notes = levelData.desc; // Auto-fill notes with level description
                        }
                    }
                    return updatedBlock;
                });
                updateProjectBlocks(updatedBlocks);
            };

            const deleteBlock = (blockId) => {
                // Fixed: Removed confirmation dialogue for instant deletion
                updateProjectBlocks(activeProject.blocks.filter(b => b.id !== blockId));
            };

            const updateProjectBlocks = (blocks) => {
                const updatedProject = { ...activeProject, blocks, updatedAt: Date.now() };
                setProjects(projects.map(p => p.id === activeProjectId ? updatedProject : p));
                if(user) db.collection('users').doc(user.uid).collection('projects').doc(activeProjectId).update({ blocks, updatedAt: Date.now() });
            };

            // Drag & Drop
            const handleDragStart = (index) => setDraggedItemIndex(index);
            const handleDragEnter = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;
                const newBlocks = [...activeProject.blocks];
                const item = newBlocks[draggedItemIndex];
                newBlocks.splice(draggedItemIndex, 1);
                newBlocks.splice(index, 0, item);
                setDraggedItemIndex(index);
                setProjects(projects.map(p => p.id === activeProjectId ? { ...activeProject, blocks: newBlocks } : p));
            };
            const handleDragEnd = () => {
                setDraggedItemIndex(null);
                if(user) db.collection('users').doc(user.uid).collection('projects').doc(activeProjectId).update({ blocks: activeProject.blocks });
            };

            const getBlockIcon = (type) => {
                switch(type) {
                    case 'service': return 'box';
                    case 'service-template': return 'box';
                    case 'material': return 'layers';
                    case 'milestone': return 'check';
                    default: return 'box';
                }
            };

            const totalEstimate = activeProject.blocks?.reduce((acc, b) => acc + (parseFloat(b.price) || 0), 0) || 0;

            const printAgreement = () => window.print();

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 bg-cover bg-center transition-all duration-700">
                    {/* Fixed: Moved BG image to a fixed div to act as true wallpaper */}
                    <div className="fixed inset-0 z-0">
                        <img src={settings.bgImage} className="w-full h-full object-cover" alt="Background" />
                        <div className="absolute inset-0 bg-black/50 backdrop-blur-md"></div>
                    </div>
                    
                    <div className="relative z-10 glass-panel p-10 rounded-2xl text-center max-w-md w-full">
                        <h1 className="text-3xl font-bold mb-2">FocusFlow</h1>
                        <p className="text-sm opacity-80 mb-6">Production Management Suite</p>
                        <button onClick={login} className="bg-white text-black px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center justify-center gap-2 w-full">
                            <Icon name="google" /> Sign In with Google
                        </button>
                    </div>
                </div>
            );

            return (
                /* Fixed: Changed from min-h-screen to h-screen for fixed viewport height */
                <div className="h-screen w-full flex text-gray-800 font-sans overflow-hidden bg-cover bg-center transition-all duration-700 relative">
                    {/* Fixed: Wallpaper as separate fixed layer */}
                    <div className="fixed inset-0 z-0">
                        <img src={settings.bgImage} className="w-full h-full object-cover" alt="Background" />
                        <div className="absolute inset-0 bg-black/20"></div>
                    </div>
                    
                    {/* LEFT SIDEBAR */}
                    <div className="w-64 glass-sidebar flex flex-col z-10 shadow-2xl relative text-white">
                        <div className="p-5 border-b border-white/10">
                            <div className="mb-4 relative group cursor-pointer" onClick={() => setShowSettings(true)}>
                                {settings.logoUrl ? <img src={settings.logoUrl} className="h-10 object-contain" /> : <div className="h-10 border-2 border-dashed border-white/30 rounded flex items-center justify-center text-xs text-white/50">+ Add Logo</div>}
                            </div>
                            <h2 className="font-bold tracking-tight truncate">{settings.companyName}</h2>
                            <p className="text-[10px] uppercase tracking-wider text-white/50 font-semibold mt-1">Production Management</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
                            <div className="flex justify-between items-center px-2 mb-2"><span className="text-xs font-bold text-white/40 uppercase">Projects</span><button onClick={createProject} className="text-white hover:bg-white/20 p-1 rounded"><Icon name="plus" size={14}/></button></div>
                            {projects.map(p => (
                                <button key={p.id} onClick={() => setActiveProjectId(p.id)} className={`w-full text-left px-3 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 transition-all ${activeProjectId === p.id ? 'bg-white/20 shadow-lg border border-white/10' : 'text-white/60 hover:bg-white/5'}`}>
                                    <Icon name="box" size={14} className={activeProjectId === p.id ? "text-white" : "text-white/40"} />
                                    <span className="truncate">{p.name}</span>
                                </button>
                            ))}
                        </div>
                        <div className="p-4 border-t border-white/10 bg-white/5 flex items-center gap-3">
                            <img src={user.photoURL} className="w-8 h-8 rounded-full border border-white/30" />
                            <div className="flex-1 min-w-0"><p className="text-xs font-bold truncate">{user.displayName}</p></div>
                            <button onClick={() => setShowSettings(true)} className="text-white/60 hover:text-white"><Icon name="settings" /></button>
                        </div>
                    </div>

                    {/* MAIN WORKSPACE */}
                    <div className="flex-1 flex flex-col z-10 relative overflow-hidden">
                        <header className="h-16 glass-header flex justify-between items-center px-8 shadow-sm shrink-0">
                            <div>
                                <h1 className="text-xl font-bold text-white drop-shadow-md">{activeProject.name}</h1>
                                <span className="text-xs text-white/60">Last updated: {new Date(activeProject.updatedAt || Date.now()).toLocaleTimeString()}</span>
                            </div>
                            <button onClick={() => setShowInvoice(true)} className="bg-white/20 border border-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/30 backdrop-blur transition-all flex items-center gap-2">
                                <Icon name="fileText" size={16} /> Client View
                            </button>
                        </header>

                        {/* Fixed: Added min-h-0 to allow flex child to scroll properly */}
                        <div className="flex-1 min-h-0 overflow-y-auto p-8 custom-scrollbar relative">
                            <div className="max-w-4xl mx-auto space-y-3 pb-24"> 
                                {activeProject.blocks && activeProject.blocks.length === 0 && (
                                    <div className="text-center py-20 border-2 border-dashed border-white/20 rounded-xl bg-white/5 text-white/50 backdrop-blur-sm">
                                        <p>Select a tool from the right to start.</p>
                                    </div>
                                )}

                                {activeProject.blocks && activeProject.blocks.map((block, index) => (
                                    <div 
                                        key={block.id}
                                        draggable={true}
                                        onDragStart={() => handleDragStart(index)}
                                        onDragEnter={(e) => handleDragEnter(e, index)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={(e) => e.preventDefault()}
                                        className={`block-card p-4 shadow-lg flex gap-4 items-start group animate-fade-in block-type-${block.type === 'service-template' ? 'service' : block.type} rounded-xl ${draggedItemIndex === index ? 'dragging' : ''}`}
                                    >
                                        <div className="pt-1 text-gray-400 cursor-grab hover:text-indigo-500"><Icon name="grip" size={16} /></div>
                                        <div className="pt-1 text-gray-600"><Icon name={getBlockIcon(block.type)} size={18} /></div>
                                        
                                        <div className="flex-1 space-y-2">
                                            <div className="flex justify-between items-start gap-4">
                                                <div className="flex-1">
                                                    <input type="text" value={block.title} onChange={(e) => updateBlock(block.id, 'title', e.target.value)} className="font-bold text-gray-900 text-lg w-full bg-transparent p-0 border-none focus:ring-0" />
                                                    {/* Template Level Selector */}
                                                    {block.type === 'service-template' && block.levels && (
                                                        <select 
                                                            value={block.selectedLevel || 'standard'} 
                                                            onChange={(e) => updateBlock(block.id, 'selectedLevel', e.target.value)}
                                                            className="text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 rounded px-2 py-1 mt-1 cursor-pointer hover:bg-indigo-100"
                                                        >
                                                            {Object.keys(block.levels).map(lvl => (
                                                                block.levels[lvl].active && <option key={lvl} value={lvl}>{lvl.charAt(0).toUpperCase() + lvl.slice(1)}</option>
                                                            ))}
                                                        </select>
                                                    )}
                                                </div>
                                                <div className="flex items-center gap-1 bg-white/50 px-2 py-1 rounded-md border border-white/40 shadow-sm shrink-0">
                                                    <span className="text-gray-500 text-xs">$</span>
                                                    <input type="number" value={block.price} onChange={(e) => updateBlock(block.id, 'price', e.target.value)} className="w-24 text-right font-mono font-medium text-sm text-gray-800" placeholder="0.00" />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="flex items-center gap-2 bg-white/40 p-1.5 rounded-lg border border-white/20 focus-within:border-indigo-300 transition-colors">
                                                    <Icon name="link" size={12} className="text-gray-400" />
                                                    <input type="text" placeholder="Reference link..." value={block.link} onChange={(e) => updateBlock(block.id, 'link', e.target.value)} className="text-xs w-full text-blue-700" />
                                                </div>
                                                <div className="flex items-center gap-2 bg-white/40 p-1.5 rounded-lg border border-white/20 focus-within:border-indigo-300 transition-colors">
                                                    <Icon name="fileText" size={12} className="text-gray-400" />
                                                    <input type="text" placeholder="Notes..." value={block.notes} onChange={(e) => updateBlock(block.id, 'notes', e.target.value)} className="text-xs w-full text-gray-700" />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-2">
                                            <button onClick={() => deleteBlock(block.id)} className="p-1.5 rounded-md bg-white/50 text-gray-400 hover:text-red-600 hover:bg-red-50 shadow-sm transition-colors"><Icon name="trash" size={16} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* STICKY BOTTOM ESTIMATE BAR */}
                        <div className="h-16 bg-white/10 backdrop-blur-xl border-t border-white/10 flex items-center justify-between px-8 text-white shrink-0 shadow-[0_-10px_20px_rgba(0,0,0,0.2)]">
                            <span className="text-sm font-medium opacity-70">Total Project Estimate</span>
                            <div className="flex items-center gap-4">
                                <span className="text-2xl font-bold font-mono">${totalEstimate.toLocaleString()}</span>
                                <button onClick={() => setShowInvoice(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-all flex items-center gap-2">
                                    Proceed <Icon name="chevronRight" size={16} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT SIDEBAR (TOOLBOX) */}
                    <div className="w-72 glass-sidebar border-l border-white/10 flex flex-col z-10 shadow-2xl text-white">
                        <div className="p-5 border-b border-white/10">
                            <h3 className="text-xs font-bold text-white/50 uppercase tracking-wider">Toolbox</h3>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                            {/* Standard Tools */}
                            <div className="space-y-2">
                                <p className="text-[10px] text-white/40 uppercase font-bold pl-1">Basic Blocks</p>
                                <button onClick={() => addBlock('service')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-indigo-500/20 text-indigo-200 flex items-center justify-center"><Icon name="box" /></div><span className="text-sm font-bold">Custom Service</span></button>
                                <button onClick={() => addBlock('material')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-orange-500/20 text-orange-200 flex items-center justify-center"><Icon name="layers" /></div><span className="text-sm font-bold">Material</span></button>
                                <button onClick={() => addBlock('milestone')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-green-500/20 text-green-200 flex items-center justify-center"><Icon name="check" /></div><span className="text-sm font-bold">Milestone</span></button>
                            </div>

                            {/* Predefined Services */}
                            <div className="space-y-2 pt-2 border-t border-white/10">
                                <div className="flex justify-between items-center pl-1">
                                    <p className="text-[10px] text-white/40 uppercase font-bold">Services</p>
                                    <button onClick={() => setShowServiceManager(true)} className="text-[10px] text-indigo-300 hover:text-indigo-100 hover:underline">Manage</button>
                                </div>
                                <button onClick={() => setServicesExpanded(!servicesExpanded)} className="w-full flex justify-between items-center text-sm text-white/70 hover:bg-white/5 p-2 rounded transition">
                                    <span>Available Services ({predefinedServices.length})</span>
                                    <div className={`transform transition ${servicesExpanded ? 'rotate-180' : ''}`}><Icon name="chevronDown" size={14} /></div>
                                </button>
                                {servicesExpanded && (
                                    <div className="space-y-2 animate-fade-in pl-2">
                                        {predefinedServices.map(svc => (
                                            <button key={svc.id} onClick={() => addBlock('service-template', svc)} className="w-full text-left p-2.5 rounded-lg bg-indigo-900/30 border border-indigo-500/20 hover:bg-indigo-900/50 hover:border-indigo-500/40 transition text-sm">
                                                <div className="font-bold text-indigo-100">{svc.name}</div>
                                                <div className="text-[10px] text-indigo-300 mt-0.5 truncate">{svc.description || "No description"}</div>
                                            </button>
                                        ))}
                                        {predefinedServices.length === 0 && <p className="text-xs text-white/30 text-center py-2">No services yet.</p>}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* --- MODALS --- */}

                    {/* Service Manager Modal */}
                    {showServiceManager && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
                            <div className="bg-white w-[500px] max-h-[80vh] rounded-xl shadow-2xl overflow-hidden flex flex-col animate-fade-in text-gray-800">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h3 className="font-bold text-lg">Manage Services</h3>
                                    <button onClick={() => setShowServiceManager(false)}><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                    <ServiceCreator onSave={savePredefinedService} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="glass-panel bg-white/95 p-6 w-[500px] rounded-2xl shadow-2xl animate-fade-in text-gray-800 max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">Settings</h3><button onClick={() => setShowSettings(false)}><Icon name="x" /></button></div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase block mb-1">Company Name</label><input type="text" value={settings.companyName} onChange={(e) => updateSettings({...settings, companyName: e.target.value})} className="w-full p-2 border rounded-lg bg-white/50" /></div>
                                    <div>
                                        <label className="text-xs font-bold uppercase block mb-1">Company Logo</label>
                                        <div className="flex gap-2">
                                            <button onClick={() => fileInputRef.current.click()} className="flex-1 p-2 border border-dashed rounded-lg bg-gray-50 hover:bg-gray-100 text-sm text-gray-500 flex items-center justify-center gap-2"><Icon name="upload" size={14} /> Upload</button>
                                            <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                                        </div>
                                    </div>
                                    <div><label className="text-xs font-bold uppercase block mb-1">Wallpaper URL</label><input type="text" value={settings.bgImage} onChange={(e) => updateSettings({...settings, bgImage: e.target.value})} className="w-full p-2 border rounded-lg bg-white/50" /></div>
                                    <div>
                                        <label className="text-xs font-bold uppercase block mb-1">Agreement Template</label>
                                        <textarea value={settings.agreementText} onChange={(e) => updateSettings({...settings, agreementText: e.target.value})} className="w-full p-2 border rounded-lg bg-white/50 text-xs font-mono h-32" />
                                        <p className="text-[10px] text-gray-400 mt-1">Use [Client Name], [Total Price], etc. placeholders.</p>
                                    </div>
                                    <div className="flex justify-between pt-4 border-t mt-4">
                                        <button onClick={logout} className="text-red-500 text-sm font-medium hover:underline">Sign Out</button>
                                        <button onClick={() => setShowSettings(false)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-indigo-700">Done</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Invoice/Agreement Modal */}
                    {showInvoice && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                            <div className="bg-white w-[700px] h-[80vh] rounded-sm shadow-2xl animate-fade-in flex flex-col text-gray-800">
                                {showAgreement ? (
                                    // AGREEMENT VIEW
                                    <>
                                        <div className="flex-1 overflow-y-auto p-12 bg-white" id="agreement-print-area">
                                            <div className="mb-8 text-center border-b pb-4">
                                                {settings.logoUrl && <img src={settings.logoUrl} className="h-16 mx-auto mb-2 object-contain" />}
                                                <h2 className="font-bold text-xl uppercase tracking-widest">{settings.companyName}</h2>
                                            </div>
                                            <div className="prose prose-sm max-w-none font-serif whitespace-pre-wrap leading-relaxed">
                                                {settings.agreementText
                                                    .replace('[Company Name]', settings.companyName)
                                                    .replace('[Client Name]', 'Valued Client') // Placeholder
                                                    .replace('[Total Price]', `$${totalEstimate.toLocaleString()}`)
                                                    .replace('[Date]', new Date().toLocaleDateString())
                                                }
                                            </div>
                                            <div className="mt-12 pt-8 border-t border-gray-300">
                                                <h3 className="font-bold mb-4">Project Summary</h3>
                                                <ul className="list-disc pl-5 text-sm space-y-1">
                                                    {activeProject.blocks.map(b => (
                                                        <li key={b.id}>{b.title} <span className="text-gray-500">({b.notes || b.type})</span> - <b>${parseFloat(b.price).toLocaleString()}</b></li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                        <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                                            <button onClick={() => setShowAgreement(false)} className="text-gray-500 hover:text-black">Back to Estimate</button>
                                            <button onClick={printAgreement} className="bg-black text-white px-6 py-2 rounded font-bold shadow hover:bg-gray-800 flex items-center gap-2"><Icon name="print" /> Print / PDF</button>
                                        </div>
                                    </>
                                ) : (
                                    // ESTIMATE VIEW
                                    <>
                                        <div className="flex-1 overflow-y-auto p-8">
                                            <div className="flex justify-between border-b pb-6 mb-6">
                                                <div className="flex items-center gap-3">
                                                    {settings.logoUrl && <img src={settings.logoUrl} className="h-12 object-contain" />}
                                                    <h2 className="font-bold text-2xl">{settings.companyName}</h2>
                                                </div>
                                                <div className="text-right"><p className="text-xs text-gray-400">DATE</p><p className="font-bold">{new Date().toLocaleDateString()}</p></div>
                                            </div>
                                            <table className="w-full text-left text-sm">
                                                <thead><tr className="border-b text-gray-400 text-xs uppercase"><th className="pb-2">Item</th><th className="pb-2 text-right">Price</th></tr></thead>
                                                <tbody>{activeProject.blocks.map(b => (<tr key={b.id}><td className="py-3 border-b border-gray-100"><p className="font-bold">{b.title}</p><p className="text-gray-400 text-xs">{b.notes}</p></td><td className="py-3 border-b border-gray-100 text-right font-mono">${parseFloat(b.price||0).toLocaleString()}</td></tr>))}</tbody>
                                            </table>
                                        </div>
                                        <div className="bg-gray-50 p-8 border-t border-gray-100 flex justify-between items-center">
                                            <div className="text-left">
                                                <button onClick={() => setShowInvoice(false)} className="text-gray-400 text-sm hover:text-black mr-4">Close</button>
                                            </div>
                                            <div className="flex items-center gap-6">
                                                <div className="text-right"><p className="text-xs text-gray-400 font-bold uppercase">Total</p><p className="text-3xl font-bold text-indigo-900">${totalEstimate.toLocaleString()}</p></div>
                                                <button onClick={() => setShowAgreement(true)} className="bg-indigo-600 text-white px-6 py-3 rounded font-bold shadow hover:bg-indigo-700">Proceed to Agreement</button>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- SUB-COMPONENTS ---
        
        const ServiceCreator = ({ onSave }) => {
            const [name, setName] = useState("");
            const [desc, setDesc] = useState("");
            const [levels, setLevels] = useState({
                basic: { active: true, price: 0, desc: "Basic features" },
                standard: { active: true, price: 0, desc: "Standard features" },
                premium: { active: true, price: 0, desc: "Premium features" }
            });

            const handleLevelChange = (lvl, field, val) => {
                setLevels(prev => ({...prev, [lvl]: { ...prev[lvl], [field]: val }}));
            };

            const handleSubmit = () => {
                if(!name) return alert("Name is required");
                onSave({ name, description: desc, levels });
                setName(""); setDesc("");
            };

            return (
                <div className="space-y-6">
                    <div>
                        <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Service Name</label>
                        <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full border p-2 rounded bg-gray-50" placeholder="e.g. Web Development" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Short Description</label>
                        <input type="text" value={desc} onChange={e => setDesc(e.target.value)} className="w-full border p-2 rounded bg-gray-50" placeholder="e.g. Full stack websites" />
                    </div>
                    
                    <div className="space-y-4">
                        {['basic', 'standard', 'premium'].map(lvl => (
                            <div key={lvl} className={`border rounded-lg p-3 ${levels[lvl].active ? 'bg-white border-indigo-200' : 'bg-gray-50 opacity-50'}`}>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" checked={levels[lvl].active} onChange={e => handleLevelChange(lvl, 'active', e.target.checked)} />
                                        <span className="font-bold capitalize">{lvl}</span>
                                    </label>
                                </div>
                                {levels[lvl].active && (
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="col-span-1">
                                            <input type="number" placeholder="Price" value={levels[lvl].price} onChange={e => handleLevelChange(lvl, 'price', e.target.value)} className="w-full border p-1 rounded text-sm" />
                                        </div>
                                        <div className="col-span-2">
                                            <input type="text" placeholder="Description" value={levels[lvl].desc} onChange={e => handleLevelChange(lvl, 'desc', e.target.value)} className="w-full border p-1 rounded text-sm" />
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    <button onClick={handleSubmit} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Add Service to Library</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>