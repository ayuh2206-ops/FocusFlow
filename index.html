<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow | Production Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PDF Lib for Agreement Generation -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; background: #111; color: #fff; }
        
        /* Ultra Glass Theme */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px); 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); 
        }
        
        .glass-sidebar {
            background: rgba(10, 10, 10, 0.25);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Draggable Cards */
        .block-card { 
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.2s;
            border-left: 4px solid transparent;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #1f2937;
        }
        .block-card:hover { 
            transform: translateY(-2px); 
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .block-card.dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1;
            background: rgba(255, 255, 255, 0.4);
        }
        
        .block-type-service { border-left-color: #4f46e5; } 
        .block-type-material { border-left-color: #ea580c; } 
        .block-type-milestone { border-left-color: #16a34a; } 

        /* Custom Dropdown */
        .custom-dropdown-menu {
            animation: scaleIn 0.15s ease-out forwards;
            transform-origin: top right;
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Subtask Item Styles */
        .subtask-item {
            transition: all 0.2s ease;
        }
        .subtask-item:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateX(4px);
        }
        .subtask-item.dragging {
            opacity: 0.5;
            border: 1px dashed #6366f1;
        }
        
        /* Custom Checkbox */
        .custom-checkbox input:checked + div {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Inputs */
        input, select, textarea { background: transparent !important; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; }
        input::placeholder { color: rgba(0,0,0,0.4); }
        
        textarea { resize: vertical; min-height: 60px; }

        @media print {
            body * { visibility: hidden; }
            #agreement-print-area, #agreement-print-area * { visibility: visible; }
            #agreement-print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 40px; background: white; color: black; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCuQLeXXVYEgG9TJ1XR_FvlD1ABqsgEXX4",
            authDomain: "focus-flow-512ee.firebaseapp.com",
            projectId: "focus-flow-512ee",
            storageBucket: "focus-flow-512ee.firebasestorage.app",
            messagingSenderId: "861618381374",
            appId: "1:861618381374:web:4692b742e3661e539c676f",
            measurementId: "G-33P6VZPJ7Y"
        };

        let auth = null, db = null, isFirebaseEnabled = false;
        try {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseEnabled = true;
            }
        } catch (e) { console.error("Firebase Init Failed:", e); }

        // --- ICONS ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const icons = {
                box: <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />,
                layers: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />,
                settings: <g><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></g>,
                trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                plus: <path d="M12 5v14M5 12h14" />,
                check: <path d="M20 6L9 17l-5-5" />,
                link: <g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g>,
                fileText: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></g>,
                logOut: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></g>,
                chevronRight: <polyline points="9 18 15 12 9 6" />,
                chevronDown: <polyline points="6 9 12 15 18 9" />,
                image: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
                grip: <g><circle cx="9" cy="12" r="1" /><circle cx="9" cy="5" r="1" /><circle cx="9" cy="19" r="1" /><circle cx="15" cy="12" r="1" /><circle cx="15" cy="5" r="1" /><circle cx="15" cy="19" r="1" /></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></g>,
                print: <g><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></g>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></g>,
                pdf: <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />,
                archive: <g><polyline points="21 8 21 21 3 21 3 8" /><rect x="1" y="3" width="22" height="5" /><line x1="10" y1="12" x2="14" y2="12" /></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const defaultAgreement = `AGREEMENT FOR SERVICES

BETWEEN: [Company Name] ("Provider")
AND: [Client Name] ("Client")

1. SERVICES
Provider agrees to perform the services described in the attached Project Estimate.

2. PAYMENT
Total Estimated Cost: [Total Price]
Payment terms: 50% upfront, 50% upon completion.

3. TIMELINE
Expected Delivery Date: [Delivery Date]
Services will be delivered according to the milestones defined in the project scope.

Date: [Date]
Signed: __________________________`;

        const CustomSelect = ({ value, options, onChange, disabled }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (ref.current && !ref.current.contains(event.target)) setIsOpen(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div className="relative" ref={ref}>
                    <button 
                        onClick={() => !disabled && setIsOpen(!isOpen)} 
                        disabled={disabled}
                        className={`flex items-center gap-2 text-xs font-bold px-3 py-1.5 rounded-full transition-colors ${disabled ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-indigo-100 hover:bg-indigo-200 text-indigo-800'}`}
                    >
                        {value.charAt(0).toUpperCase() + value.slice(1)}
                        {!disabled && <Icon name="chevronDown" size={12} />}
                    </button>
                    {isOpen && !disabled && (
                        <div className="absolute top-full right-0 mt-1 w-32 bg-white/90 backdrop-blur-xl border border-white/20 rounded-xl shadow-2xl z-50 overflow-hidden custom-dropdown-menu">
                            {options.map((opt) => (
                                <button
                                    key={opt.value}
                                    onClick={() => { onChange(opt.value); setIsOpen(false); }}
                                    className={`w-full text-left px-4 py-2 text-xs font-medium hover:bg-indigo-50 flex items-center justify-between ${value === opt.value ? 'text-indigo-600 bg-indigo-50/50' : 'text-gray-700'}`}
                                >
                                    {opt.label}
                                    {value === opt.value && <Icon name="check" size={12} />}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- BLOCK COMPONENT ---
        const BlockItem = ({ block, index, updateBlock, deleteBlock, handleDragStart, handleDragEnter, handleDragEnd, draggedItemIndex, getBlockIcon, isProduction, isEditing }) => {
            const [newSubTask, setNewSubTask] = useState("");
            const [draggedSubtaskIndex, setDraggedSubtaskIndex] = useState(null);
            const [editingSubtaskId, setEditingSubtaskId] = useState(null);
            const [editingSubtaskText, setEditingSubtaskText] = useState("");

            const addSubTask = () => {
                if(!newSubTask.trim()) return;
                const subtasks = [...(block.subtasks || []), { id: Date.now(), text: newSubTask.trim(), completed: false }];
                updateBlock(block.id, 'subtasks', subtasks);
                setNewSubTask("");
            };

            const toggleSubTask = (subId) => {
                const subtasks = (block.subtasks || []).map(t => t.id === subId ? { ...t, completed: !t.completed } : t);
                updateBlock(block.id, 'subtasks', subtasks);
            };

            const removeSubTask = (subId) => {
                const subtasks = (block.subtasks || []).filter(t => t.id !== subId);
                updateBlock(block.id, 'subtasks', subtasks);
            };

            const startEditingSubtask = (task) => {
                setEditingSubtaskId(task.id);
                setEditingSubtaskText(task.text);
            };

            const saveEditingSubtask = () => {
                if (editingSubtaskId) {
                    const subtasks = (block.subtasks || []).map(t => t.id === editingSubtaskId ? { ...t, text: editingSubtaskText } : t);
                    updateBlock(block.id, 'subtasks', subtasks);
                    setEditingSubtaskId(null);
                    setEditingSubtaskText("");
                }
            };

            const handleSubtaskDragStart = (idx) => setDraggedSubtaskIndex(idx);
            const handleSubtaskDragEnter = (e, idx) => {
                e.preventDefault();
                if (draggedSubtaskIndex === null || draggedSubtaskIndex === idx) return;
                const subtasks = [...(block.subtasks || [])];
                const item = subtasks[draggedSubtaskIndex];
                subtasks.splice(draggedSubtaskIndex, 1);
                subtasks.splice(idx, 0, item);
                setDraggedSubtaskIndex(idx);
                updateBlock(block.id, 'subtasks', subtasks);
            };
            const handleSubtaskDragEnd = () => setDraggedSubtaskIndex(null);

            const isLocked = isProduction && !isEditing;

            return (
                <div 
                    draggable={!isLocked}
                    onDragStart={!isLocked ? () => handleDragStart(index) : undefined}
                    onDragEnter={!isLocked ? (e) => handleDragEnter(e, index) : undefined}
                    onDragEnd={!isLocked ? handleDragEnd : undefined}
                    onDragOver={(e) => e.preventDefault()}
                    className={`block-card p-4 shadow-lg flex flex-col gap-4 animate-fade-in block-type-${block.type === 'service-template' ? 'service' : block.type} rounded-xl ${draggedItemIndex === index ? 'dragging' : ''} ${isLocked ? 'border-l-4 border-gray-300' : ''}`}
                >
                    <div className="flex gap-4 items-start">
                        {!isLocked && (
                            <div className="pt-1 text-gray-400 cursor-grab hover:text-indigo-500"><Icon name="grip" size={16} /></div>
                        )}
                        <div className="pt-1 text-gray-600"><Icon name={getBlockIcon(block.type)} size={18} /></div>
                        
                        <div className="flex-1 space-y-2">
                            <div className="flex justify-between items-start gap-4">
                                <div className="flex-1">
                                    <div className="flex items-center gap-3">
                                        <input 
                                            type="text" 
                                            value={block.title} 
                                            onChange={(e) => updateBlock(block.id, 'title', e.target.value)} 
                                            readOnly={isLocked}
                                            className={`font-bold text-gray-900 text-lg bg-transparent p-0 border-none focus:ring-0 flex-1 ${isLocked ? 'cursor-default' : ''}`} 
                                        />
                                        
                                        {block.type === 'service-template' && block.levels && (
                                            <CustomSelect 
                                                value={block.selectedLevel || 'standard'}
                                                onChange={(val) => updateBlock(block.id, 'selectedLevel', val)}
                                                disabled={isLocked}
                                                options={['basic', 'standard', 'premium']
                                                    .filter(lvl => block.levels[lvl]?.active)
                                                    .map(lvl => ({ value: lvl, label: lvl.charAt(0).toUpperCase() + lvl.slice(1) }))}
                                            />
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-1 bg-white/50 px-2 py-1 rounded-md border border-white/40 shadow-sm shrink-0">
                                    <span className="text-gray-500 text-xs">â‚¹</span>
                                    <input 
                                        type="number" 
                                        value={block.price} 
                                        onChange={(e) => updateBlock(block.id, 'price', e.target.value)} 
                                        readOnly={isLocked}
                                        className="w-24 text-right font-mono font-medium text-sm text-gray-800" 
                                        placeholder="0.00" 
                                    />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="flex items-center gap-2 bg-white/40 p-2 rounded-lg border border-white/20 focus-within:border-indigo-300 transition-colors h-10">
                                    <Icon name="link" size={14} className="text-gray-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Reference link..." 
                                        value={block.link} 
                                        onChange={(e) => updateBlock(block.id, 'link', e.target.value)} 
                                        readOnly={isLocked}
                                        className="text-xs w-full text-blue-700" 
                                    />
                                </div>
                                
                                <div className="flex items-start gap-2 bg-white/40 p-2 rounded-lg border border-white/20 focus-within:border-indigo-300 transition-colors">
                                    <Icon name="fileText" size={14} className="text-gray-500 mt-0.5" />
                                    <textarea 
                                        placeholder="Description / Bullet points..." 
                                        value={block.notes} 
                                        onChange={(e) => updateBlock(block.id, 'notes', e.target.value)} 
                                        readOnly={isLocked}
                                        className="text-xs w-full text-gray-900 bg-transparent resize-y focus:outline-none leading-relaxed"
                                        rows={3}
                                    />
                                </div>
                            </div>
                        </div>

                        {!isLocked && (
                            <div className="flex flex-col gap-2">
                                <button onClick={() => deleteBlock(block.id)} className="p-1.5 rounded-md bg-white/50 text-gray-400 hover:text-red-600 hover:bg-red-50 shadow-sm transition-colors"><Icon name="trash" size={16} /></button>
                            </div>
                        )}
                    </div>

                    {isProduction && (
                        <div className="border-t border-gray-200/40 pt-4 mt-2 pl-10">
                            <p className="text-[10px] font-bold text-gray-400 uppercase mb-3 tracking-wide">Production Tasks</p>
                            <div className="space-y-2">
                                {(block.subtasks || []).map((task, idx) => (
                                    <div 
                                        key={task.id} 
                                        draggable={true}
                                        onDragStart={() => handleSubtaskDragStart(idx)}
                                        onDragEnter={(e) => handleSubtaskDragEnter(e, idx)}
                                        onDragEnd={handleSubtaskDragEnd}
                                        onDragOver={(e) => e.preventDefault()}
                                        className={`subtask-item flex items-center gap-3 group p-2 rounded-lg ${draggedSubtaskIndex === idx ? 'dragging' : 'bg-white/30'}`}
                                    >
                                        <div className="cursor-grab text-gray-400 opacity-0 group-hover:opacity-50 hover:opacity-100 transition-opacity">
                                            <Icon name="grip" size={12} />
                                        </div>
                                        <label className="custom-checkbox relative flex items-center cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                checked={task.completed} 
                                                onChange={() => toggleSubTask(task.id)}
                                                className="hidden"
                                            />
                                            <div className={`w-4 h-4 border-2 rounded flex items-center justify-center transition-all ${task.completed ? 'bg-indigo-600 border-indigo-600' : 'border-gray-300 bg-white'}`}>
                                                <svg className={`w-3 h-3 text-white ${task.completed ? 'block' : 'hidden'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path></svg>
                                            </div>
                                        </label>
                                        
                                        {editingSubtaskId === task.id ? (
                                            <div className="flex-1 flex gap-2">
                                                <input 
                                                    type="text" 
                                                    value={editingSubtaskText} 
                                                    onChange={(e) => setEditingSubtaskText(e.target.value)}
                                                    onKeyDown={(e) => e.key === 'Enter' && saveEditingSubtask()}
                                                    autoFocus
                                                    className="text-sm flex-1 bg-white/80 border border-indigo-300 rounded px-2 py-0.5 focus:ring-1 focus:ring-indigo-500 text-gray-800"
                                                />
                                                <button onClick={saveEditingSubtask} className="text-green-600 hover:text-green-800 text-xs font-bold">Save</button>
                                            </div>
                                        ) : (
                                            <span 
                                                onDoubleClick={() => startEditingSubtask(task)}
                                                className={`text-sm flex-1 cursor-text transition-colors ${task.completed ? 'text-gray-400 line-through' : 'text-gray-700 hover:text-indigo-900'}`}
                                            >
                                                {task.text}
                                            </span>
                                        )}

                                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => startEditingSubtask(task)} className="p-1 text-gray-400 hover:text-indigo-600 rounded hover:bg-indigo-50 transition-colors"><Icon name="edit" size={12} /></button>
                                            <button onClick={() => removeSubTask(task.id)} className="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50 transition-colors"><Icon name="trash" size={12} /></button>
                                        </div>
                                    </div>
                                ))}
                                
                                <div className="flex items-center gap-2 mt-3 bg-white/20 p-2 rounded-lg border border-white/30 focus-within:bg-white/50 transition-colors">
                                    <Icon name="plus" size={14} className="text-indigo-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Add task step..." 
                                        value={newSubTask}
                                        onChange={(e) => setNewSubTask(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && addSubTask()}
                                        className="text-sm bg-transparent border-none focus:ring-0 flex-1 text-gray-700 placeholder-gray-400"
                                    />
                                    <button 
                                        onClick={addSubTask} 
                                        disabled={!newSubTask.trim()}
                                        className="text-xs bg-indigo-600 text-white px-3 py-1 rounded-md font-medium shadow-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [settings, setSettings] = useState({ 
                companyName: "Production Studio", 
                logoUrl: "", 
                bgImage: "https://images.unsplash.com/photo-1600607686527-6fb886090705?q=80&w=2727&auto=format&fit=crop",
                agreementText: defaultAgreement
            });
            const [projects, setProjects] = useState([]);
            const [predefinedServices, setPredefinedServices] = useState([]);
            const [activeProjectId, setActiveProjectId] = useState(null);
            const [deliveryDate, setDeliveryDate] = useState("");
            
            const [showSettings, setShowSettings] = useState(false);
            const [showInvoice, setShowInvoice] = useState(false);
            const [showServiceManager, setShowServiceManager] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            
            const [servicesExpanded, setServicesExpanded] = useState(false);
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);
            const fileInputRef = useRef(null);
            const pdfInputRef = useRef(null);

            const activeProject = projects.find(p => p.id === activeProjectId) || null;
            const isProduction = activeProject?.status === 'production' || activeProject?.status === 'completed';

            useEffect(() => {
                if (!isFirebaseEnabled) return;
                return auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) {
                        db.collection('users').doc(u.uid).collection('settings').doc('config').onSnapshot(doc => {
                            if(doc.exists) setSettings(prev => ({...prev, ...doc.data()}));
                        });
                        db.collection('users').doc(u.uid).collection('projects').orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                            const loadedProjects = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                            setProjects(loadedProjects);
                            if(loadedProjects.length > 0 && !activeProjectId) setActiveProjectId(loadedProjects[0].id);
                        });
                        db.collection('users').doc(u.uid).collection('services').onSnapshot(snapshot => {
                            setPredefinedServices(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                        });
                    }
                });
            }, [activeProjectId]);

            const login = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) { alert(e.message); } };
            const logout = () => auth.signOut();

            const createProject = async () => {
                const name = prompt("Enter Project Name (Client Name):");
                if(name && user) {
                    const docRef = await db.collection('users').doc(user.uid).collection('projects').add({
                        name, blocks: [], status: 'planning', createdAt: Date.now(), updatedAt: Date.now()
                    });
                    setActiveProjectId(docRef.id);
                }
            };

            const deleteProject = async (projectId) => {
                if(confirm("Are you sure you want to delete this project? This cannot be undone.")) {
                    if(user) {
                        await db.collection('users').doc(user.uid).collection('projects').doc(projectId).delete();
                        if(activeProjectId === projectId) setActiveProjectId(null);
                    }
                }
            };

            const completeProject = async (projectId) => {
                if(user) {
                    await db.collection('users').doc(user.uid).collection('projects').doc(projectId).update({
                        status: 'completed'
                    });
                }
            };

            const updateSettings = (newSettings) => {
                setSettings(newSettings);
                if(user) db.collection('users').doc(user.uid).collection('settings').doc('config').set(newSettings, { merge: true });
            };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (file.size > 500000) { 
                    alert("Image too large! Max 500KB.");
                    if(fileInputRef.current) fileInputRef.current.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onloadend = () => {
                    try {
                        updateSettings({ ...settings, logoUrl: reader.result });
                    } catch (e) {
                        alert("Failed to process image.");
                    }
                };
                reader.readAsDataURL(file);
            };

            const savePredefinedService = async (serviceData) => {
                if (!user) return;
                const { id, ...data } = serviceData;
                try {
                    if (id) {
                        await db.collection('users').doc(user.uid).collection('services').doc(id).update(data);
                    } else {
                        await db.collection('users').doc(user.uid).collection('services').add(data);
                    }
                } catch (e) {
                    alert("Error saving service: " + e.message);
                }
            };

            const deletePredefinedService = async (id) => {
                if (!user || !id) return;
                if(confirm("Delete this service template?")) {
                    try {
                        await db.collection('users').doc(user.uid).collection('services').doc(id).delete();
                    } catch(e) {
                        alert("Delete error: " + e.message);
                    }
                }
            };

            const addBlock = (type, template = null) => {
                if(!activeProjectId) return alert("Please create or select a project from the left sidebar first.");
                if(isProduction && !isEditing) return alert("Project is in Production Mode. Click 'Edit Scope' to add items.");

                const currentBlocks = activeProject ? activeProject.blocks : [];
                let newBlock = { id: Date.now().toString(), type, title: type === 'service' ? 'New Service' : type === 'material' ? 'New Material' : 'New Milestone', price: 0, link: '', notes: '', completed: false, subtasks: [] };
                
                if (type === 'service-template' && template) {
                    newBlock = { ...newBlock, title: template.name, templateId: template.id, selectedLevel: 'standard', levels: template.levels, price: template.levels.standard?.active ? template.levels.standard.price : 0, notes: template.levels.standard?.active ? template.levels.standard.desc : '' };
                    if (!template.levels.standard?.active) {
                        if (template.levels.basic?.active) { newBlock.selectedLevel = 'basic'; newBlock.price = template.levels.basic.price; newBlock.notes = template.levels.basic.desc; }
                        else if (template.levels.premium?.active) { newBlock.selectedLevel = 'premium'; newBlock.price = template.levels.premium.price; newBlock.notes = template.levels.premium.desc; }
                    }
                }
                updateProjectBlocks([...currentBlocks, newBlock]);
            };

            const updateBlock = (blockId, field, value) => {
                if (!activeProject) return;
                let updatedBlocks = activeProject.blocks.map(b => {
                    if (b.id !== blockId) return b;
                    let updatedBlock = { ...b, [field]: value };
                    if (field === 'selectedLevel' && b.type === 'service-template') {
                        const levelData = b.levels[value];
                        if (levelData) { updatedBlock.price = levelData.price; updatedBlock.notes = levelData.desc; }
                    }
                    return updatedBlock;
                });
                updateProjectBlocks(updatedBlocks);
            };

            const deleteBlock = (blockId) => {
                if (!activeProject) return;
                updateProjectBlocks(activeProject.blocks.filter(b => b.id !== blockId));
            };

            const updateProjectBlocks = (blocks) => {
                if (!activeProjectId || !user) return;
                const updatedProject = { ...activeProject, blocks, updatedAt: Date.now() };
                setProjects(projects.map(p => p.id === activeProjectId ? updatedProject : p));
                db.collection('users').doc(user.uid).collection('projects').doc(activeProjectId).update({ blocks, updatedAt: Date.now() });
            };

            const startProduction = async () => {
                await generateAndDownloadPdf();
                if(user && activeProjectId) {
                    await db.collection('users').doc(user.uid).collection('projects').doc(activeProjectId).update({ status: 'production' });
                }
                setShowInvoice(false);
            };

            const toggleEditMode = () => {
                if (isEditing) {
                    setIsEditing(false);
                } else {
                    setIsEditing(true);
                }
            };

            const handleDragStart = (index) => setDraggedItemIndex(index);
            const handleDragEnter = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;
                const newBlocks = [...activeProject.blocks];
                const item = newBlocks[draggedItemIndex];
                newBlocks.splice(draggedItemIndex, 1);
                newBlocks.splice(index, 0, item);
                setDraggedItemIndex(index);
                setProjects(projects.map(p => p.id === activeProjectId ? { ...activeProject, blocks: newBlocks } : p));
            };
            const handleDragEnd = () => {
                setDraggedItemIndex(null);
                if(user) db.collection('users').doc(user.uid).collection('projects').doc(activeProjectId).update({ blocks: activeProject.blocks });
            };

            const getBlockIcon = (type) => {
                switch(type) { case 'service': return 'box'; case 'service-template': return 'box'; case 'material': return 'layers'; case 'milestone': return 'check'; default: return 'box'; }
            };

            const totalEstimate = activeProject?.blocks?.reduce((acc, b) => acc + (parseFloat(b.price) || 0), 0) || 0;
            
            const generateAndDownloadPdf = async () => {
                if (typeof PDFLib === 'undefined') return alert("PDF Library not loaded.");
                
                try {
                    const { PDFDocument, rgb, StandardFonts } = PDFLib;
                    const pdfDoc = await PDFDocument.create();
                    const page = pdfDoc.addPage([600, 850]);
                    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                    
                    let y = 780;
                    const margin = 50;

                    // Header
                    page.drawText("PROJECT AGREEMENT", { x: margin, y, size: 24, font: fontBold });
                    y -= 40;
                    
                    page.drawText(`Provider: ${settings.companyName || "Provider Name"}`, { x: margin, y, size: 12, font });
                    y -= 20;
                    page.drawText(`Client: ${activeProject?.name || "Client Name"}`, { x: margin, y, size: 12, font });
                    y -= 20;
                    page.drawText(`Date: ${new Date().toLocaleDateString()}`, { x: margin, y, size: 12, font });
                    y -= 40;

                    // Services
                    page.drawText("SERVICES & DELIVERABLES", { x: margin, y, size: 14, font: fontBold });
                    y -= 10;
                    page.drawLine({ start: { x: margin, y }, end: { x: 550, y }, thickness: 1, color: rgb(0.8, 0.8, 0.8) });
                    y -= 25;

                    (activeProject?.blocks || []).forEach(block => {
                        const title = `${block.title} (${block.selectedLevel || 'Standard'})`;
                        const price = `INR ${block.price}`;
                        page.drawText(title, { x: margin, y, size: 12, font: fontBold });
                        page.drawText(price, { x: 450, y, size: 12, font: fontBold, align: 'right' });
                        y -= 15;
                        
                        if (block.notes) {
                            const words = block.notes.split(' ');
                            let line = '';
                            words.forEach(word => {
                                if ((line + word).length > 85) {
                                    page.drawText(line, { x: margin + 10, y, size: 10, font, color: rgb(0.4, 0.4, 0.4) });
                                    y -= 14;
                                    line = '';
                                }
                                line += word + ' ';
                            });
                            if(line) {
                                page.drawText(line, { x: margin + 10, y, size: 10, font, color: rgb(0.4, 0.4, 0.4) });
                                y -= 20;
                            }
                        } else {
                            y -= 20;
                        }
                    });

                    y -= 10;
                    page.drawLine({ start: { x: margin, y }, end: { x: 550, y }, thickness: 1, color: rgb(0.8, 0.8, 0.8) });
                    y -= 30;
                    page.drawText(`TOTAL ESTIMATE: INR ${totalEstimate.toLocaleString('en-IN')}`, { x: margin, y, size: 16, font: fontBold });
                    
                    y -= 50;
                    page.drawText("TERMS & CONDITIONS", { x: margin, y, size: 12, font: fontBold });
                    y -= 20;
                    
                    const terms = [
                        "1. Scope: Services will be performed as listed above.",
                        "2. Payment: 50% deposit required to begin work.",
                        `3. Delivery: Estimated completion by ${deliveryDate || "TBD"}.`,
                        "4. Validity: This estimate is valid for 14 days."
                    ];
                    
                    terms.forEach(term => {
                        page.drawText(term, { x: margin, y, size: 10, font });
                        y -= 15;
                    });

                    y -= 60;
                    page.drawLine({ start: { x: margin, y }, end: { x: 250, y }, thickness: 1 });
                    page.drawLine({ start: { x: 350, y }, end: { x: 550, y }, thickness: 1 });
                    y -= 15;
                    page.drawText("Provider Signature", { x: margin, y, size: 10, font });
                    page.drawText("Client Signature", { x: 350, y, size: 10, font });

                    const pdfBytes = await pdfDoc.save();
                    download(pdfBytes, `${activeProject?.name || 'Project'}_Agreement.pdf`, "application/pdf");
                } catch (error) {
                    console.error("Auto PDF Error:", error);
                    alert("Error generating PDF: " + error.message);
                }
            };

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 bg-cover bg-center transition-all duration-700">
                    <div className="fixed inset-0 z-0">
                        <img src={settings.bgImage} className="w-full h-full object-cover" alt="Background" />
                        <div className="absolute inset-0 bg-black/50 backdrop-blur-md"></div>
                    </div>
                    <div className="relative z-10 glass-panel p-10 rounded-2xl text-center max-w-md w-full">
                        <h1 className="text-3xl font-bold mb-2">FocusFlow</h1>
                        <p className="text-sm opacity-80 mb-6">Production Management Suite</p>
                        <button onClick={login} className="bg-white text-black px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition flex items-center justify-center gap-2 w-full">
                            <Icon name="google" /> Sign In with Google
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="h-screen w-full flex text-gray-800 font-sans overflow-hidden bg-cover bg-center transition-all duration-700 relative">
                    <div className="fixed inset-0 z-0">
                        <img src={settings.bgImage} className="w-full h-full object-cover" alt="Background" />
                        <div className="absolute inset-0 bg-black/20"></div>
                    </div>
                    
                    {/* SIDEBAR */}
                    <div className="w-64 glass-sidebar flex flex-col z-10 shadow-2xl relative text-white">
                        <div className="p-5 border-b border-white/10">
                            <div className="mb-4 relative group cursor-pointer" onClick={() => setShowSettings(true)}>
                                {settings.logoUrl ? <img src={settings.logoUrl} className="h-10 object-contain" /> : <div className="h-10 border-2 border-dashed border-white/30 rounded flex items-center justify-center text-xs text-white/50">+ Add Logo</div>}
                            </div>
                            <h2 className="font-bold tracking-tight truncate">{settings.companyName}</h2>
                            <p className="text-[10px] uppercase tracking-wider text-white/50 font-semibold mt-1">Production Management</p>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
                            <div className="flex justify-between items-center px-2 mb-2"><span className="text-xs font-bold text-white/40 uppercase">Projects</span><button onClick={createProject} className="text-white hover:bg-white/20 p-1 rounded"><Icon name="plus" size={14}/></button></div>
                            {projects.map(p => (
                                <div key={p.id} className="flex items-center group">
                                    <button onClick={() => setActiveProjectId(p.id)} className={`flex-1 text-left px-3 py-2.5 rounded-l-lg text-sm font-medium flex items-center gap-2 transition-all ${activeProjectId === p.id ? 'bg-white/20 shadow-lg border-l border-t border-b border-white/10' : 'text-white/60 hover:bg-white/5'}`}>
                                        <div className="flex items-center gap-2 flex-1 overflow-hidden">
                                            {p.status === 'completed' ? <Icon name="archive" size={14} className="text-blue-300" /> : p.status === 'production' ? <div className="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]"></div> : <Icon name="box" size={14} className="text-white/40" />}
                                            <span className={`truncate ${p.status === 'completed' ? 'line-through opacity-50' : ''}`}>{p.name}</span>
                                        </div>
                                    </button>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); deleteProject(p.id); }}
                                        className={`px-2 py-2.5 rounded-r-lg hover:bg-red-500/20 hover:text-red-400 transition-colors ${activeProjectId === p.id ? 'bg-white/20 border-r border-t border-b border-white/10' : 'text-white/20 hover:bg-white/5'}`}
                                        title="Delete Project"
                                    >
                                        <Icon name="trash" size={12} />
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-white/10 bg-white/5 flex items-center gap-3">
                            <img src={user.photoURL} className="w-8 h-8 rounded-full border border-white/30" />
                            <div className="flex-1 min-w-0"><p className="text-xs font-bold truncate">{user.displayName}</p></div>
                            <button onClick={() => setShowSettings(true)} className="text-white/60 hover:text-white"><Icon name="settings" /></button>
                        </div>
                    </div>

                    {/* MAIN WORKSPACE */}
                    <div className="flex-1 flex flex-col z-10 relative overflow-hidden">
                        <header className="h-16 glass-header flex justify-between items-center px-8 shadow-sm shrink-0">
                            <div>
                                <div className="flex items-center gap-3">
                                    <h1 className="text-xl font-bold text-white drop-shadow-md">{activeProject ? activeProject.name : 'Select a Project'}</h1>
                                    {activeProject?.status === 'production' && <span className="bg-green-500/20 border border-green-500/50 text-green-300 text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wide">Production Mode</span>}
                                    {activeProject?.status === 'completed' && <span className="bg-blue-500/20 border border-blue-500/50 text-blue-300 text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wide">Completed</span>}
                                </div>
                                {activeProject && <span className="text-xs text-white/60">Last updated: {new Date(activeProject.updatedAt || Date.now()).toLocaleTimeString()}</span>}
                            </div>
                            
                            <div className="flex items-center gap-3">
                                {isProduction ? (
                                    <>
                                        {activeProject.status !== 'completed' && (
                                            <button onClick={() => completeProject(activeProject.id)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg transition-all flex items-center gap-2">
                                                <Icon name="check" size={16} /> Mark Completed
                                            </button>
                                        )}
                                        {activeProject.status !== 'completed' && (
                                            isEditing ? (
                                                <button onClick={toggleEditMode} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-all flex items-center gap-2">
                                                    <Icon name="check" size={16} /> Save Changes
                                                </button>
                                            ) : (
                                                <button onClick={toggleEditMode} className="bg-white/10 border border-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/20 transition-all flex items-center gap-2">
                                                    <Icon name="edit" size={16} /> Edit Scope
                                                </button>
                                            )
                                        )}
                                        <button onClick={generateAndDownloadPdf} className="bg-white/10 border border-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/20 transition-all flex items-center gap-2">
                                            <Icon name="print" size={16} /> Agreement
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={() => setShowInvoice(true)} className="bg-white/20 border border-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-white/30 backdrop-blur transition-all flex items-center gap-2">
                                        <Icon name="fileText" size={16} /> Client View
                                    </button>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 min-h-0 overflow-y-auto p-8 custom-scrollbar relative">
                            <div className="max-w-4xl mx-auto space-y-3 pb-24"> 
                                {!activeProject && (
                                    <div className="text-center py-20 border-2 border-dashed border-white/20 rounded-xl bg-white/5 text-white/50 backdrop-blur-sm">
                                        <p>Please create or select a project from the left sidebar.</p>
                                    </div>
                                )}
                                {activeProject && activeProject.blocks && activeProject.blocks.length === 0 && (
                                    <div className="text-center py-20 border-2 border-dashed border-white/20 rounded-xl bg-white/5 text-white/50 backdrop-blur-sm">
                                        <p>Select a tool from the right to start.</p>
                                    </div>
                                )}

                                {activeProject && activeProject.blocks && activeProject.blocks.map((block, index) => (
                                    <BlockItem 
                                        key={block.id}
                                        block={block}
                                        index={index}
                                        updateBlock={updateBlock}
                                        deleteBlock={deleteBlock}
                                        handleDragStart={handleDragStart}
                                        handleDragEnter={handleDragEnter}
                                        handleDragEnd={handleDragEnd}
                                        draggedItemIndex={draggedItemIndex}
                                        getBlockIcon={getBlockIcon}
                                        isProduction={isProduction}
                                        isEditing={isEditing}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* STICKY BOTTOM ESTIMATE BAR */}
                        <div className="h-16 bg-white/10 backdrop-blur-xl border-t border-white/10 flex items-center justify-between px-8 text-white shrink-0 shadow-[0_-10px_20px_rgba(0,0,0,0.2)]">
                            <span className="text-sm font-medium opacity-70">Total Project Estimate</span>
                            <div className="flex items-center gap-4">
                                <span className="text-2xl font-bold font-mono">â‚¹{totalEstimate.toLocaleString('en-IN')}</span>
                                {!isProduction && (
                                    <button onClick={() => setShowInvoice(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-all flex items-center gap-2">
                                        Proceed <Icon name="chevronRight" size={16} />
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* RIGHT SIDEBAR (Only visible in Planning or Editing Mode) */}
                    {(!isProduction || isEditing) && (
                        <div className="w-72 glass-sidebar border-l border-white/10 flex flex-col z-10 shadow-2xl text-white">
                            <div className="p-5 border-b border-white/10">
                                <h3 className="text-xs font-bold text-white/50 uppercase tracking-wider">Toolbox</h3>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                <div className="space-y-2">
                                    <p className="text-[10px] text-white/40 uppercase font-bold pl-1">Basic Blocks</p>
                                    <button onClick={() => addBlock('service')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-indigo-500/20 text-indigo-200 flex items-center justify-center"><Icon name="box" /></div><span className="text-sm font-bold">Custom Service</span></button>
                                    <button onClick={() => addBlock('material')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-orange-500/20 text-orange-200 flex items-center justify-center"><Icon name="layers" /></div><span className="text-sm font-bold">Material</span></button>
                                    <button onClick={() => addBlock('milestone')} className="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-3 rounded-xl flex items-center gap-3 transition-all text-left"><div className="w-8 h-8 rounded bg-green-500/20 text-green-200 flex items-center justify-center"><Icon name="check" /></div><span className="text-sm font-bold">Milestone</span></button>
                                </div>

                                <div className="space-y-2 pt-2 border-t border-white/10">
                                    <div className="flex justify-between items-center pl-1">
                                        <p className="text-[10px] text-white/40 uppercase font-bold">Services</p>
                                        <button onClick={() => setShowServiceManager(true)} className="text-[10px] text-indigo-300 hover:text-indigo-100 hover:underline">Manage</button>
                                    </div>
                                    <button onClick={() => setServicesExpanded(!servicesExpanded)} className="w-full flex justify-between items-center text-sm text-white/70 hover:bg-white/5 p-2 rounded transition">
                                        <span>Available Services ({predefinedServices.length})</span>
                                        <div className={`transform transition ${servicesExpanded ? 'rotate-180' : ''}`}><Icon name="chevronDown" size={14} /></div>
                                    </button>
                                    {servicesExpanded && (
                                        <div className="space-y-2 animate-fade-in pl-2">
                                            {predefinedServices.map(svc => (
                                                <button key={svc.id} onClick={() => addBlock('service-template', svc)} className="w-full text-left p-2.5 rounded-lg bg-indigo-900/30 border border-indigo-500/20 hover:bg-indigo-900/50 hover:border-indigo-500/40 transition text-sm">
                                                    <div className="font-bold text-indigo-100">{svc.name}</div>
                                                    <div className="text-[10px] text-indigo-300 mt-0.5 truncate">{svc.description || "No description"}</div>
                                                </button>
                                            ))}
                                            {predefinedServices.length === 0 && <p className="text-xs text-white/30 text-center py-2">No services yet.</p>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODALS */}
                    {showServiceManager && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
                            <div className="bg-white w-[500px] max-h-[80vh] rounded-xl shadow-2xl overflow-hidden flex flex-col animate-fade-in text-gray-800">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h3 className="font-bold text-lg">Manage Services</h3>
                                    <button onClick={() => setShowServiceManager(false)}><Icon name="x" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                    <ServiceCreator services={predefinedServices} onSave={savePredefinedService} onDelete={deletePredefinedService} />
                                </div>
                            </div>
                        </div>
                    )}

                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="glass-panel bg-white/95 p-6 w-[500px] rounded-2xl shadow-2xl animate-fade-in text-gray-800 max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">Settings</h3><button onClick={() => setShowSettings(false)}><Icon name="x" /></button></div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase block mb-1">Company Name</label><input type="text" value={settings.companyName} onChange={(e) => updateSettings({...settings, companyName: e.target.value})} className="w-full p-2 border rounded-lg bg-white/50" /></div>
                                    <div>
                                        <label className="text-xs font-bold uppercase block mb-1">Company Logo</label>
                                        <div className="flex gap-2">
                                            <button onClick={() => fileInputRef.current.click()} className="flex-1 p-2 border border-dashed rounded-lg bg-gray-50 hover:bg-gray-100 text-sm text-gray-500 flex items-center justify-center gap-2"><Icon name="upload" size={14} /> Upload</button>
                                            <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                                        </div>
                                    </div>
                                    <div><label className="text-xs font-bold uppercase block mb-1">Wallpaper URL</label><input type="text" value={settings.bgImage} onChange={(e) => updateSettings({...settings, bgImage: e.target.value})} className="w-full p-2 border rounded-lg bg-white/50" /></div>
                                    
                                    <div className="flex justify-between pt-4 border-t mt-4">
                                        <button onClick={logout} className="text-red-500 text-sm font-medium hover:underline">Sign Out</button>
                                        <button onClick={() => setShowSettings(false)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-indigo-700">Done</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showInvoice && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                            <div className="bg-white w-[700px] h-[80vh] rounded-sm shadow-2xl animate-fade-in flex flex-col text-gray-800">
                                <div className="flex-1 overflow-y-auto p-8">
                                    <div className="flex justify-between border-b pb-6 mb-6">
                                        <div className="flex items-center gap-3">
                                            {settings.logoUrl && <img src={settings.logoUrl} className="h-12 object-contain" />}
                                            <h2 className="font-bold text-2xl">{settings.companyName}</h2>
                                        </div>
                                        <div className="text-right"><p className="text-xs text-gray-400">DATE</p><p className="font-bold">{new Date().toLocaleDateString()}</p></div>
                                    </div>
                                    
                                    {/* Delivery Date Input */}
                                    <div className="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100 flex items-center justify-between">
                                        <label className="text-sm font-bold text-indigo-800 flex items-center gap-2">
                                            <Icon name="calendar" size={16} /> Expected Delivery Date:
                                        </label>
                                        <input 
                                            type="date" 
                                            value={deliveryDate} 
                                            onChange={(e) => setDeliveryDate(e.target.value)}
                                            className="bg-white border border-indigo-200 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                        />
                                    </div>

                                    <table className="w-full text-left text-sm">
                                        <thead><tr className="border-b text-gray-400 text-xs uppercase"><th className="pb-2">Item</th><th className="pb-2 text-right">Price</th></tr></thead>
                                        <tbody>{activeProject && activeProject.blocks && activeProject.blocks.map(b => (<tr key={b.id}><td className="py-3 border-b border-gray-100"><p className="font-bold">{b.title}</p><p className="text-gray-400 text-xs">{b.notes}</p></td><td className="py-3 border-b border-gray-100 text-right font-mono">â‚¹{parseFloat(b.price||0).toLocaleString('en-IN')}</td></tr>))}</tbody>
                                    </table>
                                </div>
                                <div className="bg-gray-50 p-8 border-t border-gray-100 flex justify-between items-center">
                                    <div className="text-left">
                                        <button onClick={() => setShowInvoice(false)} className="text-gray-400 text-sm hover:text-black mr-4">Close</button>
                                    </div>
                                    <div className="flex items-center gap-6">
                                        <div className="text-right"><p className="text-xs text-gray-400 font-bold uppercase">Total</p><p className="text-3xl font-bold text-indigo-900">â‚¹{totalEstimate.toLocaleString('en-IN')}</p></div>
                                        <button 
                                            onClick={() => {
                                                if(!deliveryDate) return alert("Please set a delivery date first.");
                                                startProduction();
                                            }} 
                                            className="bg-indigo-600 text-white px-6 py-3 rounded font-bold shadow hover:bg-indigo-700"
                                        >
                                            Save & Download Agreement
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ServiceCreator = ({ services, onSave, onDelete }) => {
            const [editingId, setEditingId] = useState(null);
            const [name, setName] = useState("");
            const [desc, setDesc] = useState("");
            const [levels, setLevels] = useState({
                basic: { active: true, price: 0, desc: "Basic features" },
                standard: { active: true, price: 0, desc: "Standard features" },
                premium: { active: true, price: 0, desc: "Premium features" }
            });
            
            const formTopRef = useRef(null);

            useEffect(() => {
                // Form reset logic kept for safety, but main population happens via handleEditClick
                if (!editingId) {
                    setName(""); setDesc("");
                    setLevels({ basic: { active: true, price: 0, desc: "Basic features" }, standard: { active: true, price: 0, desc: "Standard features" }, premium: { active: true, price: 0, desc: "Premium features" } });
                }
            }, [editingId]);

            const handleLevelChange = (lvl, field, val) => {
                setLevels(prev => ({...prev, [lvl]: { ...prev[lvl], [field]: val }}));
            };

            const handleEditClick = (service) => {
                setEditingId(service.id);
                setName(service.name);
                setDesc(service.description);
                // Safely merge in case of missing level data
                const defaultLevels = {
                    basic: { active: true, price: 0, desc: "Basic features" },
                    standard: { active: true, price: 0, desc: "Standard features" },
                    premium: { active: true, price: 0, desc: "Premium features" }
                };
                setLevels({ ...defaultLevels, ...service.levels });
                
                // Auto-scroll to top
                formTopRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const handleSubmit = () => {
                if(!name) return alert("Name is required");
                onSave({ id: editingId, name, description: desc, levels });
                setEditingId(null);
            };

            return (
                <div ref={formTopRef} className="space-y-8">
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wide">{editingId ? "Edit Service" : "Create New Service"}</h4>
                            {editingId && <button onClick={() => setEditingId(null)} className="text-xs text-red-500 hover:text-red-700 font-medium">Cancel Edit</button>}
                        </div>
                        <div><label className="block text-xs font-bold uppercase text-gray-500 mb-1">Service Name</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full border p-2 rounded bg-gray-50 focus:bg-white transition-colors" placeholder="e.g. Web Development" /></div>
                        <div><label className="block text-xs font-bold uppercase text-gray-500 mb-1">Short Description</label><input type="text" value={desc} onChange={e => setDesc(e.target.value)} className="w-full border p-2 rounded bg-gray-50 focus:bg-white transition-colors" placeholder="e.g. Full stack websites" /></div>
                        <div className="space-y-4">
                            {['basic', 'standard', 'premium'].map(lvl => (
                                <div key={lvl} className={`border rounded-lg p-3 transition-all ${levels[lvl].active ? 'bg-white border-indigo-200 shadow-sm' : 'bg-gray-50 opacity-50 border-gray-100'}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" checked={levels[lvl].active} onChange={e => handleLevelChange(lvl, 'active', e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500" /><span className="font-bold capitalize text-gray-700">{lvl}</span></label>
                                    </div>
                                    {levels[lvl].active && (
                                        <div className="grid grid-cols-3 gap-2 animate-fade-in">
                                            <div className="col-span-1"><input type="number" placeholder="Price" value={levels[lvl].price} onChange={e => handleLevelChange(lvl, 'price', e.target.value)} className="w-full border p-1.5 rounded text-sm focus:border-indigo-300" /></div>
                                            <div className="col-span-2"><input type="text" placeholder="Description" value={levels[lvl].desc} onChange={e => handleLevelChange(lvl, 'desc', e.target.value)} className="w-full border p-1.5 rounded text-sm focus:border-indigo-300" /></div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        <button onClick={handleSubmit} className={`w-full py-2.5 rounded-lg font-bold shadow-md transition-all transform hover:scale-[1.02] active:scale-[0.98] ${editingId ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}>{editingId ? "Update Service" : "Add Service to Library"}</button>
                    </div>
                    <div className="border-t pt-6">
                        <h4 className="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4">Service Library</h4>
                        {services.length === 0 ? <p className="text-sm text-gray-400 text-center py-4 italic">No services created yet.</p> : (
                            <div className="space-y-3">
                                {services.map(svc => (
                                    <div key={svc.id} className={`flex items-center justify-between p-3 rounded-lg border transition-all ${editingId === svc.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300 bg-white'}`}>
                                        <div><p className="font-bold text-sm text-gray-800">{svc.name}</p><p className="text-xs text-gray-500 truncate max-w-[200px]">{svc.description || "No description"}</p></div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleEditClick(svc)} className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-100 rounded transition-colors" title="Edit"><Icon name="edit" size={14} /></button>
                                            <button onClick={() => onDelete(svc.id)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded transition-colors" title="Delete"><Icon name="trash" size={14} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>